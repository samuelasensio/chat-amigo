<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chatillo ‚Äî Minimal Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: #0b0f1a;
    --bg2: #111827;
    --bg3: #1f2937;
    --text: #e5e7eb;
    --text2: #9ca3af;
    --accent: #4f46e5;
    --radius: 12px;
    --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* SIDEBAR ICONS (Discord style but minimal) */
  #sidebarIcons {
    width: 70px;
    background: black;
    border-right: 1px solid #0f172a;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 18px 0;
    gap: 22px;
  }

  .iconBtn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #111827;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: .2s;
  }

  .iconBtn:hover {
    background: #1f2937;
  }

  /* SECOND SIDEBAR (rooms list) */
  #sidebar {
    width: 260px;
    background: var(--bg2);
    border-right: 1px solid #0f172a;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  #sidebar h3 {
    margin: 0;
    font-size: 14px;
    text-transform: uppercase;
    color: var(--text2);
    letter-spacing: .05em;
  }

  #rooms {
    flex: 1;
    overflow-y: auto;
    padding-right: 4px;
  }

  .roomBtn {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 8px;
    background: var(--bg3);
    border-radius: var(--radius);
    border: none;
    color: var(--text);
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    transition: .2s;
  }

  .roomBtn:hover {
    background: #374151;
  }

  .roomBtn.active {
    background: var(--accent);
  }

  /* CHAT AREA */
  #chat {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #chatHeader {
    padding: 20px;
    border-bottom: 1px solid #0f172a;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(10px);
  }

  #chatHeader h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 500;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }

  .msgWrap {
    margin-bottom: 16px;
  }

  .bubble {
    display: inline-block;
    padding: 12px 16px;
    border-radius: var(--radius);
    background: var(--bg3);
    max-width: 70%;
    font-size: 15px;
    line-height: 1.45;
  }

  .me .bubble {
    background: var(--accent);
    color: white;
    margin-left: auto;
  }

  #sendBox {
    display: flex;
    padding: 16px;
    gap: 12px;
    border-top: 1px solid #0f172a;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(10px);
  }

  input, button {
    border: none;
    outline: none;
    border-radius: var(--radius);
    padding: 12px;
    font-size: 15px;
    font-family: var(--font);
  }

  input {
    flex: 1;
    background: #0b0f1a;
    color: var(--text);
    border: 1px solid #1f2937;
  }

  button {
    background: var(--accent);
    color: white;
    cursor: pointer;
    transition: .2s;
  }

  button:hover {
    background: #6366f1;
  }

  /* LOGIN OVERLAY */
  #login {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.7);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #login form {
    background: var(--bg2);
    padding: 32px;
    border-radius: var(--radius);
    width: 320px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    border: 1px solid #1f2937;
  }

  #login h2 {
    margin: 0 0 6px;
    text-align: center;
  }

  .error {
    color: #f87171;
    font-size: 13px;
    text-align: center;
    min-height: 16px;
  }
</style>
</head>
<body>

<!-- SIDEBAR ICONS -->
<div id="sidebarIcons">
  <div class="iconBtn">üè†</div>
  <div class="iconBtn">üí¨</div>
  <div class="iconBtn">‚öôÔ∏è</div>
</div>

<!-- SIDEBAR ROOMS -->
<div id="sidebar">
  <h3>Salas</h3>
  <div id="rooms"></div>

  <h3>Nueva sala</h3>
  <input id="roomName" placeholder="Nombre de sala">
  <button id="createRoom">Crear</button>
</div>

<!-- CHAT -->
<div id="chat">
  <div id="chatHeader">
    <h2 id="roomTitle">Selecciona una sala</h2>
  </div>

  <div id="messages"></div>

  <div id="sendBox">
    <input id="msg" placeholder="Escribe un mensaje..." disabled>
    <button id="send" disabled>Enviar</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login">
  <form id="loginForm">
    <h2>Chatillo</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Contrase√±a">
    <div class="error" id="loginError"></div>
    <button>Entrar</button>
  </form>
</div>

<script>
const API = "TU_WORKER_URL"; // ‚Üê CAMBIA ESTO

let token = null;
let user = null;
let currentRoom = null;
let poll = null;

async function api(path, method="GET", body=null) {
  const res = await fetch(API+path, {
    method,
    headers: {
      "Content-Type":"application/json",
      ...(token ? { "Authorization":"Bearer "+token } : {})
    },
    body: body ? JSON.stringify(body) : null
  });
  return res.json();
}

loginForm.onsubmit = async e => {
  e.preventDefault();
  loginError.textContent = "";
  const r = await api("/api/login","POST",{email:email.value,password:password.value});
  if(r.error){ loginError.textContent="Credenciales incorrectas"; return }
  token = r.token;
  user = r.user;
  login.style.display="none";
  loadRooms();
};

async function loadRooms(){
  const r = await api("/api/rooms");
  rooms.innerHTML="";
  r.rooms.forEach(room=>{
    const b=document.createElement("button");
    b.className="roomBtn";
    b.textContent=room.name;
    b.onclick=()=>joinRoom(room.id, room.name, b);
    rooms.appendChild(b);
  });
}

async function joinRoom(id, name, btn){
  currentRoom=id;
  roomTitle.textContent=name;
  msg.disabled=false;
  send.disabled=false;
  Array.from(document.querySelectorAll(".roomBtn")).forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  if(poll) clearInterval(poll);
  await loadMessages();
  poll=setInterval(loadMessages,1500);
}

async function loadMessages(){
  const r = await api(`/api/rooms/${currentRoom}/messages`);
  messages.innerHTML="";
  r.messages.forEach(m=>{
    const wrap=document.createElement("div");
    wrap.className="msgWrap "+(m.email===user.email?"me":"");
    const bubble=document.createElement("div");
    bubble.className="bubble";
    bubble.textContent=m.text;
    wrap.appendChild(bubble);
    messages.appendChild(wrap);
  });
  messages.scrollTop=messages.scrollHeight;
}

send.onclick = async ()=>{
  if(!msg.value.trim()) return;
  await api(`/api/rooms/${currentRoom}/messages`,"POST",{text:msg.value});
  msg.value="";
  loadMessages();
};

createRoom.onclick = async ()=>{
  const name = roomName.value.trim();
  if(!name) return;
  await api("/api/rooms","POST",{name});
  roomName.value="";
  loadRooms();
};
</script>

</body>
</html>

